---
// 3D model that rotates to face you as you scroll
---

<div id="model-container"></div>

<style>
  #model-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 150px;
    height: 150px;
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.8s ease-in-out;
  }

  #model-container.loaded {
    opacity: 1;
  }

  @media (max-width: 768px) {
    #model-container {
      width: 100px;
      height: 100px;
      bottom: 10px;
      right: 10px;
    }
  }
</style>

<script>
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

  function initModel() {
    const container = document.getElementById('model-container');
    if (!container) return;

    // Scene setup
    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
    camera.position.z = 3;

    const renderer = new THREE.WebGLRenderer({
      antialias: true,
      alpha: true
    });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setClearColor(0x000000, 0);
    container.appendChild(renderer.domElement);

    // Lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(2, 2, 2);
    scene.add(directionalLight);

    const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
    backLight.position.set(-2, -2, -2);
    scene.add(backLight);

    // Load model
    let model: THREE.Group | null = null;
    const loader = new GLTFLoader();

    loader.load(
      '/model.glb',
      (gltf) => {
        model = gltf.scene;

        // Center and scale the model
        const box = new THREE.Box3().setFromObject(model);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());

        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 1.5 / maxDim;
        model.scale.setScalar(scale);

        model.position.sub(center.multiplyScalar(scale));

        // Initial rotation: facing away (back of head toward viewer)
        model.rotation.y = Math.PI;

        scene.add(model);

        // Fade in the container after model is loaded
        container.classList.add('loaded');
      },
      undefined,
      (error) => {
        console.error('Error loading model:', error);
      }
    );

    // Scroll tracking
    let targetRotation = Math.PI; // Start facing away
    let currentRotation = Math.PI;

    function updateScrollProgress() {
      const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollProgress = scrollHeight > 0 ? window.scrollY / scrollHeight : 0;

      // Rotate from PI (facing away) to 0 (facing viewer) as scroll progresses
      targetRotation = Math.PI * (1 - scrollProgress);
    }

    window.addEventListener('scroll', updateScrollProgress, { passive: true });
    updateScrollProgress();

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);

      // Smooth rotation interpolation
      currentRotation += (targetRotation - currentRotation) * 0.08;

      if (model) {
        model.rotation.y = currentRotation;
      }

      renderer.render(scene, camera);
    }
    animate();

    // Handle resize
    function onResize() {
      const width = container.clientWidth;
      const height = container.clientHeight;

      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      renderer.setSize(width, height);
    }

    window.addEventListener('resize', onResize);

    // Cleanup on page navigation (for Astro view transitions)
    document.addEventListener('astro:before-swap', () => {
      renderer.dispose();
      window.removeEventListener('scroll', updateScrollProgress);
      window.removeEventListener('resize', onResize);
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initModel);
  } else {
    initModel();
  }

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initModel);
</script>
